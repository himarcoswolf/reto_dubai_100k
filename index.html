<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>El Reto Dubai 100K</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="preconnect" href="https://cdn.tailwindcss.com" crossorigin>
<link rel="dns-prefetch" href="https://www.gstatic.com">
<script src="https://cdn.tailwindcss.com" defer></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js" defer></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js" defer></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap');
:root { color-scheme: dark; }
* { box-sizing: border-box; }
html, body { height: 100%; }
body{
  font-family:'Inter',sans-serif;margin:0;padding:0;
  background:linear-gradient(135deg,#0f172a 0%,#1e3a8a 50%,#0f172a 100%);
  color:white;min-height:100vh
}
@keyframes pulse{0%,100%{box-shadow:0 0 20px rgba(6,182,212,0.4)}50%{box-shadow:0 0 40px rgba(6,182,212,0.8)}}
@keyframes slide{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-5px)}}
.pulse{animation:pulse 2s infinite}
.slide{animation:slide 0.5s ease-out}
.bob{animation:bob 2s infinite}
::-webkit-scrollbar{width:8px}
::-webkit-scrollbar-track{background:rgba(0,0,0,0.3)}
::-webkit-scrollbar-thumb{background:rgba(6,182,212,0.5);border-radius:4px}
</style>
</head>
<body>
<div id="app" aria-live="polite"></div>

<script defer>
/** ================================
 *  ⚡ Rendimiento y estabilidad
 *  - Misma config Firebase y misma clave admin.
 *  - Render "throttled" y con cache para evitar repintados innecesarios.
 *  =================================
**/

// ---- Firebase (SIN CAMBIOS DE CONFIG) ----
window.addEventListener('DOMContentLoaded', () => {
  try {
    if (!firebase.apps.length) {
      firebase.initializeApp({
        apiKey:"AIzaSyB5KzKadpKslPn6cJrZUAxZ3gXTF_GWazE",
        authDomain:"reto-dubai-100k-10k.firebaseapp.com",
        databaseURL:"https://reto-dubai-100k-10k-default-rtdb.firebaseio.com",
        projectId:"reto-dubai-100k-10k",
        storageBucket:"reto-dubai-100k-10k.firebasestorage.app",
        messagingSenderId:"460196197011",
        appId:"1:460196197011:web:aae62f87d6352351e41366"
      }); // misma conexión
    }
  } catch (e) {
    console.error('Error inicializando Firebase:', e);
  }
});
</script>

<script defer>
/* ====== Estado y helpers ====== */
const db = () => firebase.database();

const START = new Date('2025-11-01T00:00:00+04:00');
const nf0 = new Intl.NumberFormat('es-ES', { maximumFractionDigits: 0 });
const nf2 = new Intl.NumberFormat('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 2 });
const dfDayShort = new Intl.DateTimeFormat('es-ES',{ day:'numeric', month:'short' });
const dfMsg = new Intl.DateTimeFormat('es-ES',{ day:'numeric', month:'short', hour:'2-digit', minute:'2-digit' });

let data = {
  totalIngresos: 0,
  totalGastos: 0,
  ingresosPorCategoria: { consultoria: 0, realEstate: 0, inversiones: 0 },
  actualizaciones: [],
  mensajes: [],
  currentLocation: 'casa',
  currentActivity: 'Iniciando',
  locationChangedAt: new Date().toISOString()
};

let visitantes = 0;
let showAdmin = false;
let isAuth = false;
let showLogros = false;

// Evitar renders excesivos (throttle + cache HTML)
let renderPending = false;
let lastHTML = '';
const appEl = () => document.getElementById('app');

function scheduleRender() {
  if (renderPending) return;
  renderPending = true;
  // Usa requestIdleCallback cuando esté disponible; si no, requestAnimationFrame
  const cb = () => { try { render(); } finally { renderPending = false; } };
  (window.requestIdleCallback || window.requestAnimationFrame)(cb);
}

function stableStr(s){ return s==null ? '' : String(s); }

const LOCS = {
  oficina:{id:'oficina',n:'🏢 Oficina',c:'from-blue-500 to-cyan-500'},
  gimnasio:{id:'gimnasio',n:'💪 Gimnasio',c:'from-orange-500 to-red-500'},
  casa:{id:'casa',n:'🏠 Casa',c:'from-purple-500 to-pink-500'},
  reunion:{id:'reunion',n:'🤝 Reunión',c:'from-green-500 to-emerald-500'},
  mall:{id:'mall',n:'🏙️ Mall',c:'from-yellow-500 to-orange-500'},
  aeropuerto:{id:'aeropuerto',n:'✈️ Aeropuerto',c:'from-sky-500 to-blue-500'},
  restaurante:{id:'restaurante',n:'🍽️ Restaurante',c:'from-amber-500 to-orange-500'}
};

function updateData(upd){
  // set() atómico (mantenemos tu comportamiento)
  return db().ref('retoData').set({ ...data, ...upd }).catch(console.error);
}

function getDays(){
  return Math.floor((Date.now() - START.getTime()) / 86400000);
}
function getTime(){
  const ms = Date.now() - new Date(data.locationChangedAt).getTime();
  const m = Math.max(0, Math.floor(ms/60000));
  const h = Math.floor(m/60);
  return h>0 ? `${h}h ${m%60}m` : `${m}m`;
}
function getLogros(){
  const l = [];
  if (data.totalIngresos >= 25000) l.push('25k');
  if (data.totalIngresos >= 50000) l.push('50k');
  if (data.totalIngresos >= 75000) l.push('75k');
  return l;
}
function getSvg(){
  const loc=data.currentLocation;
  if(loc==='oficina'||loc==='reunion'||loc==='restaurante')return 1;
  if(loc==='gimnasio'||loc==='mall'||loc==='aeropuerto')return 2;
  return 3;
}
function renderSvg(t){
  const base='<polygon points="200,250 100,200 200,150 300,200" fill="#3b4252"/>';
  if(t===1)return`<svg viewBox="0 0 400 300" class="w-full max-w-2xl mx-auto">${base}<polygon points="180,180 220,180 230,190 170,190" fill="#5e81ac"/><rect x="190" y="165" width="20" height="15" fill="#2e3440"/><circle cx="200" cy="195" r="8" fill="#f97316" class="bob"/><ellipse cx="200" cy="205" rx="10" ry="5" fill="#3b82f6" class="bob"/></svg>`;
  if(t===2)return`<svg viewBox="0 0 400 300" class="w-full max-w-2xl mx-auto">${base}<circle cx="200" cy="182" r="9" fill="#f97316" class="bob"/><ellipse cx="200" cy="193" rx="11" ry="6" fill="#3b82f6" class="bob"/><rect x="175" y="175" width="50" height="8" fill="#434c5e"/></svg>`;
  return`<svg viewBox="0 0 400 300" class="w-full max-w-2xl mx-auto">${base}<polygon points="160,190 240,190 250,200 150,200" fill="#5e81ac"/><ellipse cx="180" cy="195" rx="15" ry="8" fill="#d8dee9"/><circle cx="190" cy="190" r="8" fill="#f97316"/><ellipse cx="190" cy="200" rx="10" ry="6" fill="#3b82f6"/></svg>`;
}

// ====== Render principal con cache ======
function render(){
  const prog = (data.totalIngresos/100000)*100;
  const budget = 10000 - data.totalGastos;
  const progB = (budget/10000)*100;
  const logros = getLogros();
  const loc = LOCS[data.currentLocation] || LOCS.casa;

  // Construimos TODO en memoria y solo actualizamos si cambió
  const html = `
<div class="min-h-screen bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 text-white">
  <div class="bg-black/50 backdrop-blur-md border-b border-cyan-500/30 p-4 sticky top-0 z-50">
    <div class="max-w-6xl mx-auto flex justify-between items-center">
      <div>
        <h1 class="text-xl font-bold bg-gradient-to-r from-cyan-400 to-orange-500 bg-clip-text text-transparent">⚡ EL RETO DUBAI 100K</h1>
        <p class="text-xs text-cyan-400/70">🔥 Tiempo real</p>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right">
          <div class="text-xs text-gray-400">Día #${getDays()}</div>
          <div class="text-xs text-orange-400">👁️ ${nf0.format(visitantes)}</div>
        </div>
        <button onclick="toggleAdmin()" class="text-2xl" aria-label="Administración">🔒</button>
      </div>
    </div>
  </div>

  <div class="max-w-6xl mx-auto px-4 py-6">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-lg p-4 text-center">
        <div class="text-sm text-cyan-400">💰 Ganado</div>
        <div class="text-2xl font-bold text-cyan-400">${nf0.format(data.totalIngresos)}€</div>
        <div class="text-xs text-gray-400">${prog.toFixed(1)}%</div>
      </div>
      <div class="bg-orange-500/10 border border-orange-500/30 rounded-lg p-4 text-center">
        <div class="text-sm text-orange-400">💸 Quedan</div>
        <div class="text-2xl font-bold ${budget<3000?'text-red-400':'text-orange-400'}">${nf0.format(budget)}€</div>
        <div class="text-xs text-gray-400">${Math.max(progB,0).toFixed(0)}%</div>
      </div>
      <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 text-center cursor-pointer" onclick="toggleLogros()">
        <div class="text-sm text-yellow-400">🏆 Logros</div>
        <div class="text-2xl font-bold text-yellow-400">${logros.length}/3</div>
      </div>
    </div>

    ${showLogros?`
    <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-xl p-6 mb-6 slide">
      <h3 class="text-lg font-bold text-yellow-400 mb-4">🏆 Logros</h3>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="p-4 rounded-lg ${logros.includes('25k')?'bg-yellow-500/20':'bg-black/30'}">
          <div class="text-3xl">${logros.includes('25k')?'🏆':'🔒'}</div>
          <div class="font-bold">25.000€</div>
          <div class="text-xs text-gray-400">${logros.includes('25k')?'¡Desbloqueado!':`Faltan ${nf0.format(25000-data.totalIngresos)}€`}</div>
        </div>
        <div class="p-4 rounded-lg ${logros.includes('50k')?'bg-cyan-500/20':'bg-black/30'}">
          <div class="text-3xl">${logros.includes('50k')?'💎':'🔒'}</div>
          <div class="font-bold">50.000€</div>
          <div class="text-xs text-gray-400">${logros.includes('50k')?'¡Desbloqueado!':data.totalIngresos>=25000?`Faltan ${nf0.format(50000-data.totalIngresos)}€`:'Desbloquea 25K'}</div>
        </div>
        <div class="p-4 rounded-lg ${logros.includes('75k')?'bg-purple-500/20':'bg-black/30'}">
          <div class="text-3xl">${logros.includes('75k')?'👑':'🔒'}</div>
          <div class="font-bold">75.000€</div>
          <div class="text-xs text-gray-400">${logros.includes('75k')?'¡Desbloqueado!':data.totalIngresos>=50000?`Faltan ${nf0.format(75000-data.totalIngresos)}€`:'Desbloquea 50K'}</div>
        </div>
      </div>
    </div>`:''}

    <div class="mb-6">
      <div class="mb-4">
        <div class="flex justify-between mb-2">
          <span class="text-sm font-semibold text-cyan-400">META: 100.000€</span>
          <span class="text-xl font-bold text-cyan-400">${nf0.format(data.totalIngresos)}€</span>
        </div>
        <div class="h-8 bg-black/50 rounded-full border border-cyan-500/30 overflow-hidden relative">
          <div class="h-full bg-gradient-to-r from-cyan-500 to-blue-500" style="width:${Math.min(prog,100)}%;transition:width 200ms"></div>
          <div class="absolute inset-0 flex items-center justify-center text-xs font-bold">${prog.toFixed(1)}% completado</div>
        </div>
      </div>
      <div>
        <div class="flex justify-between mb-2">
          <span class="text-sm font-semibold text-orange-400">PRESUPUESTO</span>
          <span class="text-xl font-bold ${budget<3000?'text-red-500':'text-orange-400'}">${nf0.format(budget)}€</span>
        </div>
        <div class="h-6 bg-black/50 rounded-full border border-orange-500/30 overflow-hidden relative">
          <div class="h-full ${budget<3000?'bg-red-600':'bg-orange-600'}" style="width:${Math.max(progB,0)}%;transition:width 200ms"></div>
          <div class="absolute inset-0 flex items-center justify-center text-xs font-bold">${Math.max(progB,0).toFixed(0)}%</div>
        </div>
      </div>
    </div>

    <div class="bg-gradient-to-br ${loc.c} p-1 rounded-xl mb-6 pulse will-change-transform">
      <div class="bg-slate-900/90 rounded-lg p-6">
        <div class="flex justify-between items-center mb-4">
          <div>
            <div class="text-sm text-gray-400">📍 Ahora en:</div>
            <div class="text-3xl font-bold">${loc.n}</div>
          </div>
          <div class="text-right">
            <div class="text-sm text-gray-400">⏱️ Hace</div>
            <div class="text-2xl font-bold text-cyan-400">${getTime()}</div>
          </div>
        </div>
        <div class="bg-black/30 rounded-lg p-3">
          <div class="text-sm text-gray-400">💬 Actividad:</div>
          <div class="text-lg font-semibold">${stableStr(data.currentActivity)}</div>
        </div>
      </div>
    </div>

    <div class="bg-slate-800/50 border-2 border-cyan-500/30 rounded-xl p-6 mb-6">
      <div class="min-h-[300px] flex items-center justify-center">
        ${renderSvg(getSvg())}
      </div>
    </div>

    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <div class="bg-cyan-500/10 border border-cyan-500/30 rounded-xl p-6">
        <h3 class="text-lg font-bold text-cyan-400 mb-4">📊 Últimas Actualizaciones</h3>
        <div class="space-y-3 max-h-96 overflow-y-auto">
          ${data.actualizaciones.length===0?'<p class="text-center text-gray-500 py-8">Sin actualizaciones</p>':
            data.actualizaciones.slice(0,10).map(a=>`
              <div class="bg-black/30 rounded-lg p-3 border border-cyan-500/20">
                <div class="flex justify-between items-start mb-1">
                  <span class="font-bold ${a.tipo==='ingreso'?'text-green-400':'text-red-400'}">
                    ${a.tipo==='ingreso'?'+':'-'}${nf2.format(a.monto)}€
                  </span>
                  <div class="flex gap-2 items-center">
                    <span class="text-xs text-gray-500">${dfDayShort.format(new Date(a.fecha))}</span>
                    ${isAuth?`<button onclick="editMov(${a.id})" class="text-xs text-blue-400">✏️</button><button onclick="deleteMov(${a.id})" class="text-xs text-red-400">🗑️</button>`:''}
                  </div>
                </div>
                <div class="text-xs text-gray-400">
                  ${a.categoria==='consultoria'?'💼 Consultorías':a.categoria==='realEstate'?'🏢 Real Estate':a.categoria==='inversiones'?'📊 Inversiones':'💸 Gastos'}
                </div>
                ${a.nota?`<div class="text-xs text-gray-300 mt-1">${stableStr(a.nota)}</div>`:''}
              </div>
            `).join('')}
        </div>
      </div>

      <div class="bg-green-500/10 border border-green-500/30 rounded-xl p-6">
        <h3 class="text-lg font-bold text-green-400 mb-4">💰 Fuentes de Ingresos</h3>
        <div class="space-y-4">
          <div class="p-3 bg-black/30 rounded-lg">
            <div class="flex justify-between items-center mb-1">
              <span>💼 Consultorías</span>
              <span class="font-bold text-cyan-400">${nf0.format(data.ingresosPorCategoria.consultoria||0)}€</span>
            </div>
            <div class="text-xs text-cyan-400">bsbcapital.io</div>
          </div>
          <div class="p-3 bg-black/30 rounded-lg">
            <div class="flex justify-between items-center mb-1">
              <span>🏢 Real Estate</span>
              <span class="font-bold text-blue-400">${nf0.format(data.ingresosPorCategoria.realEstate||0)}€</span>
            </div>
            <div class="text-xs text-blue-400">marcos@eminenceuae.com</div>
          </div>
          <div class="p-3 bg-black/30 rounded-lg">
            <div class="flex justify-between items-center">
              <span>📊 Inversiones</span>
              <span class="font-bold ${(data.ingresosPorCategoria.inversiones||0)>=0?'text-green-400':'text-red-400'}">
                ${(data.ingresosPorCategoria.inversiones||0)>0?'+':''}${nf0.format(data.ingresosPorCategoria.inversiones||0)}€
              </span>
            </div>
          </div>
          <div class="border-t border-green-500/20 pt-4">
            <div class="flex justify-between items-center p-3 bg-green-500/10 rounded-lg">
              <span class="font-bold text-green-400">TOTAL</span>
              <span class="font-bold text-green-400 text-xl">${nf0.format(data.totalIngresos)}€</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="bg-purple-500/10 border border-purple-500/30 rounded-xl p-6 mb-6">
      <h3 class="text-lg font-bold text-purple-400 mb-4">💬 Mensajes (${data.mensajes.length})</h3>
      <form onsubmit="addMsg(event)" class="mb-4">
        <div class="flex gap-2">
          <input type="text" id="newMsg" placeholder="Mensaje... 💪" maxlength="150" class="flex-1 bg-black/50 border border-purple-500/30 rounded px-3 py-2 text-sm text-white placeholder-gray-500 focus:outline-none focus:border-purple-400"/>
          <button type="submit" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-400 hover:to-pink-400 px-4 py-2 rounded font-semibold text-sm">Enviar</button>
        </div>
      </form>
      <div class="space-y-2 max-h-64 overflow-y-auto">
        ${data.mensajes.length===0?'<p class="text-center text-gray-500 py-8">Sé el primero 💬</p>':
          data.mensajes.slice(0,10).map(m=>`
            <div class="bg-black/30 rounded-lg p-3 border border-purple-500/20">
              <div class="flex justify-between items-start mb-1">
                <span class="text-xs font-semibold text-purple-400">${stableStr(m.usuario)||'Anónimo'}</span>
                <span class="text-xs text-gray-500">${dfMsg.format(new Date(m.fecha))}</span>
              </div>
              <p class="text-sm text-gray-300">${stableStr(m.texto)}</p>
            </div>
          `).join('')}
      </div>
    </div>

    <div class="text-center text-xs text-gray-500">
      <p>El Reto Dubai 100K</p>
      <p class="text-cyan-400 font-semibold">✅ Sincronizado con Firebase</p>
    </div>
  </div>

  ${showAdmin?`
  <div class="fixed inset-0 bg-black/80 flex items-center justify-center z-50 p-4">
    <div class="bg-slate-900 border-2 border-cyan-500/50 rounded-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex justify-between mb-6">
        <h2 class="text-xl font-bold text-cyan-400">🎮 Admin</h2>
        <button onclick="toggleAdmin()" class="text-2xl" aria-label="Cerrar">✕</button>
      </div>
      ${!isAuth?`
        <form onsubmit="login(event)">
          <input type="password" id="pass" placeholder="Contraseña" class="w-full bg-black/50 border border-cyan-500/30 rounded px-3 py-2 text-white mb-4"/>
          <button type="submit" class="w-full bg-gradient-to-r from-cyan-500 to-blue-500 px-4 py-3 rounded-lg font-semibold">Entrar</button>
        </form>
      `:`
        <div class="space-y-6">
          <div class="bg-purple-500/10 border border-purple-500/30 rounded-lg p-4">
            <h3 class="font-bold text-purple-400 mb-4">📍 Ubicación</h3>
            <form onsubmit="updateLoc(event)">
              <select id="loc" class="w-full bg-black/50 border border-purple-500/30 rounded px-3 py-2 text-white mb-2">
                ${Object.values(LOCS).map(l=>`<option value="${l.id}">${l.n}</option>`).join('')}
              </select>
              <input type="text" id="act" placeholder="Actividad..." maxlength="100" class="w-full bg-black/50 border border-purple-500/30 rounded px-3 py-2 text-white mb-2"/>
              <button type="submit" class="w-full bg-purple-500 px-4 py-2 rounded font-semibold">Actualizar</button>
            </form>
          </div>
          <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4">
            <h3 class="font-bold text-green-400 mb-4">💰 Nuevo</h3>
            <form onsubmit="addFin(event)">
              <select id="tipo" class="w-full bg-black/50 border border-green-500/30 rounded px-3 py-2 text-white mb-2">
                <option value="ingreso">💰 Ingreso</option>
                <option value="gasto">💸 Gasto</option>
              </select>
              <select id="cat" class="w-full bg-black/50 border border-green-500/30 rounded px-3 py-2 text-white mb-2">
                <option value="consultoria">💼 Consultorías</option>
                <option value="realEstate">🏢 Real Estate</option>
                <option value="inversiones">📊 Inversiones</option>
              </select>
              <input type="number" id="monto" placeholder="Monto €" step="0.01" required class="w-full bg-black/50 border border-green-500/30 rounded px-3 py-2 text-white mb-2"/>
              <textarea id="nota" placeholder="Nota..." rows="2" maxlength="200" class="w-full bg-black/50 border border-green-500/30 rounded px-3 py-2 text-white mb-2"></textarea>
              <button type="submit" class="w-full bg-green-500 px-4 py-3 rounded-lg font-semibold">Agregar</button>
            </form>
          </div>
          <div class="bg-black/30 border border-cyan-500/30 rounded-lg p-4">
            <h3 class="text-sm font-semibold text-cyan-400 mb-2">📊 Resumen</h3>
            <div class="grid grid-cols-2 gap-2 text-sm">
              <div>Ingresos:</div><div class="text-green-400 font-semibold text-right">${nf0.format(data.totalIngresos)}€</div>
              <div>Gastos:</div><div class="text-red-400 font-semibold text-right">${nf0.format(data.totalGastos)}€</div>
              <div>Logros:</div><div class="text-yellow-400 font-semibold text-right">${logros.length}/3 🏆</div>
              <div>Visitantes:</div><div class="text-cyan-400 font-semibold text-right">${nf0.format(visitantes)}</div>
            </div>
          </div>
        </div>
      `}
    </div>
  </div>
  `:''}
</div>
`.trim();

  if (html !== lastHTML) {
    appEl().innerHTML = html;
    lastHTML = html;
  }
}

// ====== UI toggles (igual API, más rápidas por scheduleRender) ======
function toggleAdmin(){ showAdmin = !showAdmin; scheduleRender(); }
function toggleLogros(){ showLogros = !showLogros; scheduleRender(); }

// ====== Admin auth (MISMA CONTRASEÑA) ======
function login(e){
  e.preventDefault();
  const p = document.getElementById('pass').value;
  if (p === 'Dubai2025!') { // misma clave
    isAuth = true; scheduleRender();
  } else {
    alert('Incorrecto');
  }
}

// ====== Acciones de datos ======
function updateLoc(e){
  e.preventDefault();
  const loc = document.getElementById('loc').value;
  const act = document.getElementById('act').value;
  updateData({
    currentLocation: loc,
    currentActivity: act || ('En ' + LOCS[loc].n),
    locationChangedAt: new Date().toISOString()
  }).then(()=>alert('✅'));
}

function addFin(e){
  e.preventDefault();
  const tipo = document.getElementById('tipo').value;
  const cat  = document.getElementById('cat').value;
  const m = parseFloat(document.getElementById('monto').value);
  const nota = document.getElementById('nota').value;
  if (isNaN(m) || m<=0) return alert('Inválido');

  const mov = { id: Date.now(), fecha: new Date().toISOString(), categoria: cat, monto: m, tipo: tipo, nota: nota };
  let ti = data.totalIngresos, tg = data.totalGastos, ipc = { ...data.ingresosPorCategoria };

  if (tipo === 'ingreso') { ti += m; ipc[cat] = (ipc[cat]||0) + m; }
  else { tg += m; }

  // Prepend movimiento y limita longitud
  const actualizaciones = [mov, ...(data.actualizaciones||[])].slice(0, 200);

  updateData({ totalIngresos: ti, totalGastos: tg, ingresosPorCategoria: ipc, actualizaciones })
    .then(()=>{
      document.getElementById('monto').value='';
      document.getElementById('nota').value='';
      alert('✅');
    });
}

function deleteMov(id){
  if(!confirm('¿Eliminar?'))return;
  const mov = (data.actualizaciones||[]).find(a=>a.id===id);
  if(!mov)return;

  let ti = data.totalIngresos, tg = data.totalGastos, ipc = { ...data.ingresosPorCategoria };
  if(mov.tipo==='ingreso'){ ti -= mov.monto; ipc[mov.categoria]=(ipc[mov.categoria]||0)-mov.monto; }
  else { tg -= mov.monto; }

  updateData({
    totalIngresos: ti,
    totalGastos: tg,
    ingresosPorCategoria: ipc,
    actualizaciones: (data.actualizaciones||[]).filter(a=>a.id!==id)
  });
}

function addMsg(e){
  e.preventDefault();
  const m = document.getElementById('newMsg').value;
  if (m.trim().length < 3) return alert('Muy corto');
  const nuevo = { id: Date.now(), texto: m.trim(), fecha: new Date().toISOString(), usuario: 'Anónimo' };
  const mensajes = [nuevo, ...(data.mensajes||[])].slice(0,50);
  updateData({ mensajes }).then(()=>{
    document.getElementById('newMsg').value='';
  });
}

// ====== Suscripciones Firebase (con guards y render throttling) ======
window.addEventListener('DOMContentLoaded', () => {
  try {
    db().ref('retoData').on('value', snap => {
      const d = snap.val();
      if (d && typeof d === 'object') {
        // Reemplazo directo de referencia para GC más eficiente
        data = d;
        scheduleRender();
      }
    });

    db().ref('visitantes').transaction(c => (c||0) + 1);
    db().ref('visitantes').on('value', snap => {
      const v = snap.val();
      if (typeof v === 'number') {
        visitantes = v;
        // No fuerces render inmediato; se agrupa
        scheduleRender();
      }
    });
  } catch (e) {
    console.error('Error en listeners de Firebase:', e);
  }

  // Primer render
  scheduleRender();
});

// Exponer handlers globales (para los onclick del HTML)
window.toggleAdmin = toggleAdmin;
window.toggleLogros = toggleLogros;
window.login = login;
window.updateLoc = updateLoc;
window.addFin = addFin;
window.deleteMov = deleteMov;
window.addMsg = addMsg;
</script>
</body>
</html>
